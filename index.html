<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>KOPBAM â€¢ Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#0EA5E9; --blue2:#22D3EE; --blue3:#1D4ED8;
    --ink:#0F172A; --text:#0B1220; --muted:#5B7BA0;
    --white:#ffffff; --line:#DDE8F5; --chip:#E8F3FF;
    --ok:#10B981; --warn:#F59E0B; --bad:#EF4444;
    --radius:18px; --radius-md:14px; --radius-lg:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
    background: linear-gradient(180deg, #E6F4FF 0%, #CDEBFF 45%, #BFE6FF 100%);
    min-height:100dvh;
  }
  .bg-wrap{position:fixed; inset:0; z-index:-1; overflow:hidden}
  .bg-blob{position:absolute; width:120vmax; height:120vmax; left:50%; top:0; transform:translateX(-50%); filter:blur(60px); opacity:.55}
  .b1{background:radial-gradient(closest-side at 40% 20%, #9EE8FF, transparent 60%)}
  .b2{background:radial-gradient(closest-side at 70% 0%, #A4D8FF, transparent 60%)}
  .b3{background:radial-gradient(closest-side at 30% 0%, #B0F1FF, transparent 60%)}
  .app{width:min(520px,100%); margin:0 auto; padding:0 14px 100px}

  .logo{width:28px; height:28px; object-fit:contain; border-radius:8px; display:block}
  .logo-xl{width:64px; height:64px; object-fit:contain; border-radius:14px; display:block}

  .splash{position:fixed; inset:0; display:grid; place-items:center; background:linear-gradient(135deg,#08B3FF 0%,#1AC8FF 50%,#4DDCFF 100%); z-index:99}
  .splash-logo{display:flex; align-items:center; gap:12px; color:#fff; font-weight:900; font-size:1.1rem}
  .fade-out{animation:fadeout .45s ease both}
  @keyframes fadeout{to{opacity:0; visibility:hidden}}

  .appbar{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,#0EB6FE 0%, #199AFF 100%); color:#fff; border-radius:0 0 14px 14px; box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .appbar-inner{display:flex; align-items:center; justify-content:space-between; padding:14px}
  .brand{display:flex; align-items:center; gap:10px; font-weight:900}
  .badge-pill{font-weight:800; background:rgba(255,255,255,.3); padding:6px 10px; border-radius:999px}

  .card{background:#fff; border:1px solid var(--line); border-radius:var(--radius-lg); box-shadow:0 18px 40px rgba(31,97,171,.12); padding:16px; margin:14px 0}
  .title{font-weight:900; margin-bottom:8px}
  .muted{color:var(--muted); font-weight:600}

  label{font-size:.92rem; color:#1B3C63; font-weight:700}
  input,textarea,select{width:100%; padding:13px 14px; border-radius:14px; border:1px solid var(--line); background:#F7FBFF; color:#083356}
  input:focus,textarea:focus,select:focus{outline:none; border-color:#9AD9FF; box-shadow:0 0 0 3px rgba(0,160,255,.15)}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:13px 16px; border-radius:999px; border:1px solid rgba(0,0,0,.04); cursor:pointer; font-weight:900}
  .btn-primary{background:linear-gradient(180deg, #48D3FF 0%, #0EA5E9 100%); color:#05263C; box-shadow:0 12px 30px rgba(14,165,233,.35)}
  .btn-ghost{background:#fff; color:#0F2F49; border:1px solid #D7E8F9}
  .btn[disabled]{opacity:.55; cursor:not-allowed}

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media(max-width:460px){ .grid2{grid-template-columns:1fr} }

  .view{display:none} .view.active{display:block}
  .fade{animation:fade .25s ease both} @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

  .topmenu{padding:12px 14px}
  .menu-row{display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
  .menu-item{display:flex; flex-direction:column; align-items:center; text-align:center}
  .ico-wrap{width:52px; height:52px; border-radius:16px; background:linear-gradient(180deg,#F9FDFF 0%, #EEF7FF 100%); display:grid; place-items:center; border:1px solid #DCEBFA; box-shadow:0 10px 20px rgba(32,114,189,.12)}
  .ico-wrap svg{width:28px; height:28px}
  .mname{font-size:.85rem; font-weight:800; margin-top:6px; color:#0E2E4B}

  .hero{position:relative; padding:18px; border-radius:22px; overflow:hidden; background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.84)); border:1px solid #E6F1FC}
  .hero .big{font-size:1.9rem; font-weight:900; color:#0A2035}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:var(--chip); font-weight:800; color:#1C3B5A; border:1px solid #D8E9FF}

  .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; font-weight:800}
  .b-ok{background:#E6FFF6; color:#066A4C; border:1px solid #BDF0E2}
  .b-warn{background:#FFF5E6; color:#7A4B02; border:1px solid #FFE0B0}
  .b-info{background:#EEF7FF; color:#14446E; border:1px solid #CDE5FF}
  .b-bad{background:#FFECEB; color:#7A1C1C; border:1px solid #FFC9C6}

  .ticker-card{padding:0; overflow:hidden}
  .ticker-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #E6F1FC; color:#0B3B64; font-weight:900}
  .ticker{white-space:nowrap; overflow:hidden; padding:10px 0; background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.02) 50%, rgba(0,0,0,0))}
  .ticker > div{display:inline-block; padding-left:100%; animation:ticker 16s linear infinite}
  .ticker:hover > div{animation-play-state:paused}
  @keyframes ticker { 0% { transform: translateX(0) } 100% { transform: translateX(-100%) } }

  .foot{margin:18px 0 8px; text-align:center; color:#6A88AA; font-weight:700; font-size:.86rem}
</style>
</head>
<body>

<div class="bg-wrap"><div class="bg-blob b1"></div><div class="bg-blob b2"></div><div class="bg-blob b3"></div></div>

<div id="splash" class="splash"><div class="splash-logo">
  <img class="logo-xl" src="assets/LOGO.png" alt="KOPBAM" loading="eager"> KOPBAM
</div></div>

<div class="app">

  <!-- AUTH -->
  <section id="auth" class="view active fade">
    <div class="appbar"><div class="appbar-inner">
      <div class="brand"><img class="logo" src="assets/LOGO.png" alt="KOPBAM">KOPBAM</div>
      <div class="badge-pill">Portal Karyawan</div>
    </div></div>

    <div class="card">
      <div class="title">Masuk dengan NIK & NIP</div>
      <form id="formLogin" onsubmit="event.preventDefault(); doLogin()">
        <label>NIK</label><input id="nik" maxlength="16" inputmode="numeric" placeholder="16 digit NIK" required>
        <label style="margin-top:8px">NIP</label><input id="nip" inputmode="numeric" placeholder="NIP Karyawan RSBM" required>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" type="submit">Masuk</button>
          <button class="btn btn-ghost" type="button" onclick="switchAuth('reg')">Buat akun</button>
        </div>
      </form>

      <form id="formReg" style="display:none" onsubmit="event.preventDefault(); doSignup()">
        <div class="title" style="margin-top:10px">Daftar Akun</div>
        <label>NIK</label><input id="r_nik" maxlength="16" inputmode="numeric" required>
        <label style="margin-top:8px">NIP</label><input id="r_nip" inputmode="numeric" required>
        <label style="margin-top:8px">Nama Lengkap</label><input id="r_nama" required>
        <label style="margin-top:8px">Nomor HP</label><input id="r_hp" inputmode="numeric" placeholder="62xxxxxxxxx" required>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-ghost" type="button" onclick="switchAuth('login')">Batal</button>
          <button class="btn btn-primary" type="submit">Daftar</button>
        </div>
      </form>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" class="view">
    <div class="appbar">
      <div class="appbar-inner">
        <div class="brand"><img class="logo" src="assets/LOGO.png" alt="KOPBAM">KOPBAM</div>
        <div class="badge-pill">Periode <span id="period">2025</span></div>
      </div>
      <div class="topmenu"><div class="menu-row">
        <div class="menu-item" onclick="switchTab('home')">
          <div class="ico-wrap"><svg viewBox="0 0 24 24" fill="#1E90FF"><path d="M12 3 2 12h3v9h6v-6h2v6h6v-9h3z"/></svg></div><div class="mname">Home</div>
        </div>
        <div class="menu-item" onclick="switchTab('loans')">
          <div class="ico-wrap"><svg viewBox="0 0 24 24" fill="#0EA5E9"><path d="M3 6h18v12H3zM3 10h18"/></svg></div><div class="mname">Pinjaman</div>
        </div>
        <div class="menu-item" onclick="switchTab('account')">
          <div class="ico-wrap"><svg viewBox="0 0 24 24" fill="#34C759"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4 0-8 2-8 5v3h16v-3c0-3-4-5-8-5Z"/></svg></div><div class="mname">Akun</div>
        </div>
        <div class="menu-item" onclick="switchTab('settings')">
          <div class="ico-wrap"><svg viewBox="0 0 24 24" fill="#FF9F0A"><path d="M12 8a4 4 0 1 0 4 4 4.005 4.005 0 0 0-4-4Z"/></svg></div><div class="mname">Pengaturan</div>
        </div>
        <div class="menu-item" onclick="switchTab('inbox')">
          <div class="ico-wrap"><svg viewBox="0 0 24 24" fill="#FF3B30"><path d="M20 4H4a2 2 0 0 0-2 2v1l10 6 10-6V6a2 2 0 0 0-2-2Z"/><path d="M22 8l-10 6L2 8v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2Z"/></svg></div><div class="mname">Inbox</div>
        </div>
      </div></div>
    </div>

    <!-- HOME -->
    <section id="home" class="view active fade">
      <div class="card hero">
        <div class="row" style="justify-content:space-between">
          <div><div class="muted">Limit Tersedia</div><div id="limitText" class="big">Belum ditetapkan</div></div>
          <div id="statusChip" class="chip">Menunggu verifikasi</div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btnApply" class="btn btn-primary" onclick="applyNow()">Ajukan Pinjaman</button>
          <button class="btn btn-ghost" onclick="refreshStatus()">Perbarui</button>
        </div>
        <div id="blockNote" class="muted" style="display:none; margin-top:8px">Ada pinjaman aktif. Ajukan lagi jika <b>lunas</b> atau <b>ditolak</b>.</div>
      </div>

      <div class="card ticker-card">
        <div class="ticker-head"><svg viewBox="0 0 24 24" width="18" height="18" fill="#0EA5E9"><path d="M3 11h14l4-4v10l-4-4H3z"/></svg>PENGUMUMAN</div>
        <div class="ticker"><div id="tickerText">Loadingâ€¦</div></div>
      </div>

      <div class="card">
        <div class="title">Status Pengajuan</div>
        <div id="statusBadge" class="badge b-warn">Belum diajukan</div>
        <div id="approvedWrap" style="display:none; margin-top:12px">
          <div class="row" style="justify-content:space-between; width:100%; background:#F7FBFF; border:1px solid #E6F1FC; border-radius:14px; padding:12px">
            <div><div class="muted">Jumlah Disetujui</div><div id="approvedAmt" style="font-size:1.4rem; font-weight:900">Rp 0</div></div>
            <div class="badge b-ok">Keputusan Admin</div>
          </div>
          <div style="margin-top:10px" class="muted">Pencairan hanya di <b>Kantor Koperasi</b> (tidak online).</div>
        </div>
      </div>

      <div id="instWrap" class="card" style="display:none"><div class="title">Cicilan</div><div id="instList" style="display:grid; gap:10px"></div></div>

      <div class="foot">Version 1.0.0 â€¢ Crafted by Anggara Pradana</div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="view fade">
      <div class="card"><div class="title">Daftar Pengajuan</div><div id="loansList" style="display:grid; gap:10px"></div></div>
      <div class="foot">Version 1.0.0 â€¢ Crafted by Anggara Pradana</div>
    </section>

    <!-- ACCOUNT -->
    <section id="account" class="view fade">
      <div class="card">
        <div class="title">Akun Karyawan</div>
        <div class="row">
          <img id="avatar" alt="Foto" style="width:92px;height:92px;border-radius:50%;object-fit:cover;border:2px solid #9AD9FF;box-shadow:0 10px 30px rgba(34,211,238,.25)">
          <div>
            <div id="accName" style="font-weight:900; font-size:1.06rem">-</div>
            <div id="accId" class="muted" style="font-weight:700">NIK/NIP: -</div>
            <div class="row" style="margin-top:8px">
              <label for="photo" class="btn btn-ghost" style="cursor:pointer">Ubah Foto</label>
              <input id="photo" type="file" accept="image/*" onchange="onPhoto(event)" style="display:none">
              <button class="btn btn-ghost" type="button" onclick="removePhoto()">Hapus Foto</button>
            </div>
          </div>
        </div>

        <form style="margin-top:12px" onsubmit="event.preventDefault(); saveProfile()">
          <label>Nama Lengkap</label><input id="p_nama" required>
          <div class="grid2" style="margin-top:8px">
            <div><label>Jabatan</label><input id="p_jabatan" placeholder="Perawat / Dokter / Staff"></div>
            <div><label>Unit / Bagian</label><input id="p_unit" placeholder="IGD / ICU / Keuangan"></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Tempat Lahir</label><input id="p_tempat" placeholder="Kota Kelahiran"></div>
            <div><label>Tanggal Lahir</label><input id="p_tgl" type="date"></div>
          </div>
          <label style="margin-top:8px">Alamat</label><textarea id="p_alamat" placeholder="Jalan, RT/RW, Kel/Desa, Kecamatan, Kota/Kab."></textarea>
          <label style="margin-top:8px">Nomor HP</label><input id="p_hp" inputmode="numeric" placeholder="62xxxxxxxxx">
          <div class="row" style="justify-content:space-between; width:100%; margin-top:12px">
            <button class="btn btn-ghost" type="button" onclick="switchTab('home')">Kembali</button>
            <button class="btn btn-primary" type="submit">Simpan Profil</button>
          </div>
          <div id="saveOk" class="muted" style="display:none; margin-top:8px">Tersimpan âœ”</div>
        </form>
      </div>
      <div class="foot">Version 1.0.0 â€¢ Crafted by Anggara Pradana</div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="view fade">
      <div class="card">
        <div class="title">Pengaturan</div>
        <div class="row" style="justify-content:space-between; width:100%; background:#F7FBFF; border:1px solid #E6F1FC; border-radius:14px; padding:12px">
          <div class="muted">Notifikasi</div><div class="badge b-ok">Aktif</div>
        </div>
        <div class="row" style="justify-content:space-between; width:100%; background:#F7FBFF; border:1px solid #E6F1FC; border-radius:14px; padding:12px; margin-top:10px">
          <div class="muted">Sesi</div><button class="btn btn-ghost" onclick="logout()">Keluar</button>
        </div>
      </div>
      <div class="foot">Version 1.0.0 â€¢ Crafted by Anggara Pradana</div>
    </section>

    <!-- INBOX -->
    <section id="inbox" class="view fade">
      <div class="card"><div class="title">Inbox</div><div class="muted">Notifikasi dari koperasi akan tampil di sini.</div></div>
      <div class="foot">Version 1.0.0 â€¢ Crafted by Anggara Pradana</div>
    </section>
  </section>
</div>

<script>
/* ===== CONFIG SERVER ===== */
const CONFIG = {
  GAS_URL: 'https://script.google.com/macros/s/AKfycbypW80rI-TPHyJSpCZnc8tzWiGPnJ4s3bNiWmc3mE5Wv7hB7EtbfxOB82zAUevlwidLlA/exec',
  DEPLOYMENT_ID: 'AKfycbypW80rI-TPHyJSpCZnc8tzWiGPnJ4s3bNiWmc3mE5Wv7hB7EtbfxOB82zAUevlwidLlA',
  TIMEOUT: 12000,                 // 12s
  ALLOW_SELF_REGISTER: true       // true = daftar dari app (bukan form)
};

/* ===== UTIL ===== */
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{ return d }}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v))
const idr=n=>new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n)
const mask=(s,k=4)=> s ? s.slice(0,k)+'*'.repeat(Math.max(0,s.length-k-2))+s.slice(-2) : '-'
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ===== SIMPLE FETCH WRAPPER (timeout + error text) ===== */
async function gasFetch(payload){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), CONFIG.TIMEOUT);
  try{
    const res = await fetch(CONFIG.GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload),
      signal:ctrl.signal,
      mode:'cors',
      credentials:'omit'
    });
    clearTimeout(t);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }catch(e){
    clearTimeout(t);
    throw e;
  }
}

/* ===== SEED DEMO (fallback) ===== */
(function seed(){
  if(!load('kbm_users',null)){
    save('kbm_users',[{ nik:'3276010101010001', nip:'1001', nama:'Andi Demo', phone:'62812xxxxxxx', aktif:true, limit:null,
      profile:{photo:'', jabatan:'Perawat', unit:'IGD', tempat:'Mamuju', tgl:'1992-06-21', alamat:'Jl. Contoh No.1'} }]);
  }
  if(!load('kbm_news',null)){
    save('kbm_news',["âš™ï¸ Pemeliharaan sistem 02.00â€“03.00 WITA malam ini.","ðŸ“Œ Pengajuan hanya satu kali sampai pinjaman LUNAS.","ðŸ’ Pencairan hanya di kantor Koperasi (tidak online)."]);
  }
  if(!load('kbm_apps',null)) save('kbm_apps',[]);
})();
(function ensureDemo(){
  const users = load('kbm_users', []);
  if (!users.find(u => u.nik === '3276010101010001')) {
    users.push({ nik:'3276010101010001', nip:'1001', nama:'Andi Demo', phone:'62812xxxxxxx', aktif:true, limit:null,
      profile:{photo:'', jabatan:'Perawat', unit:'IGD', tempat:'Mamuju', tgl:'1992-06-21', alamat:'Jl. Contoh No.1'} });
    save('kbm_users', users);
  }
})();

/* ===== STATE ===== */
const state={ period:String(new Date().getFullYear()), status:'belum', approved:0, limit:null, installments:[] }

/* ===== SPLASH ===== */
window.addEventListener('load', ()=> setTimeout(()=> document.getElementById('splash').classList.add('fade-out'), 700));

/* ===== AUTH ===== */
function switchAuth(mode){
  const L = document.getElementById('formLogin')
  const R = document.getElementById('formReg')
  if(mode==='reg'){ L.style.display='none'; R.style.display='block' }
  else { R.style.display='none'; L.style.display='block' }
}
if(localStorage.getItem('kbm_auth')==='1'){ openApp() }

async function doSignup(){
  if(!CONFIG.ALLOW_SELF_REGISTER){ alert('Pendaftaran via Google Form dulu. (Integrasi form â†’ sheet).'); return }
  const nik = document.getElementById('r_nik').value.trim()
  const nip = document.getElementById('r_nip').value.trim()
  const nama= document.getElementById('r_nama').value.trim()
  const hp  = document.getElementById('r_hp').value.trim()
  if(!/^\d{16}$/.test(nik)) return alert('NIK harus 16 digit')
  if(!nik || !nip || !nama || !hp) return alert('Lengkapi semua data')

  try{
    const out = await gasFetch({action:'signup', nik, nip, nama, phone:hp, deploymentId:CONFIG.DEPLOYMENT_ID});
    if(out.ok){
      alert('Pendaftaran berhasil. Silakan login.');
      switchAuth('login');
    }else{
      alert(out.msg||'Gagal daftar.');
    }
  }catch(e){
    alert('Tidak bisa daftar ke server. Pastikan Web App sudah "Anyone" dan URL benar.');
  }
}

async function doLogin(){
  const nik=document.getElementById('nik').value.trim()
  const nip=document.getElementById('nip').value.trim()
  if(!nik || !nip) return;

  try{
    const out = await gasFetch({action:'checkUser', nik, nip});
    if(out && out.aktif){
      localStorage.setItem('kbm_auth','1');
      localStorage.setItem('kbm_nik', out.nik);
      localStorage.setItem('kbm_name', out.nama || 'Karyawan');
      // simpan limit yg dikirim server (opsional)
      if(out.limit != null){
        const users = load('kbm_users',[]);
        const idx = users.findIndex(u=>u.nik===out.nik);
        if(idx>-1){ users[idx].limit = out.limit; save('kbm_users',users); }
      }
      openApp();
    }else{
      alert(out?.msg || 'Akun tidak ditemukan / tidak aktif');
    }
  }catch(e){
    alert('Tidak bisa login ke server. Pastikan Web App sudah "Anyone" dan URL benar.');
  }
}

function logout(){ localStorage.removeItem('kbm_auth'); localStorage.removeItem('kbm_nik'); localStorage.removeItem('kbm_name'); location.reload() }

/* ===== OPEN APP ===== */
async function openApp(){
  document.getElementById('auth').classList.remove('active')
  document.getElementById('auth').style.display='none'
  document.getElementById('appView').classList.add('active')
  document.getElementById('period').textContent = state.period
  await renderHome(); renderLoans(); renderAccount();
}

/* ===== TAB ===== */
function switchTab(id){
  document.querySelectorAll('#appView > section').forEach(s=>s.classList.remove('active'))
  document.getElementById(id).classList.add('active')
  if(id==='home'){ renderHome() }
  if(id==='loans'){ renderLoans() }
  if(id==='account'){ renderAccount() }
}

/* ===== RULE ===== */
function hasActiveLoan(nik){
  const active = new Set(['menunggu','verifikasi','disetujui','dicairkan'])
  const apps = load('kbm_apps',[]).filter(a=>a.nik===nik)
  return apps.some(a=> active.has(String(a.status_admin||a.status_auto||'').toLowerCase()) )
}

/* ===== HOME ===== */
async function renderHome(){
  const nik = localStorage.getItem('kbm_nik'); if(!nik) return

  // ambil profil + limit dari server (best effort)
  try{
    const out = await gasFetch({action:'profile', nik});
    if(out && out.ok && out.user){
      const users=load('kbm_users',[]); const i=users.findIndex(u=>u.nik===nik);
      if(i>-1){ users[i] = {...users[i], ...out.user}; save('kbm_users',users); }
      state.limit = out.user.limit ?? null;
    }
  }catch(e){ /* fallback ke local */ }

  const users=load('kbm_users',[]); const u=users.find(x=>x.nik===nik) || {}
  state.limit = (state.limit ?? u.limit) ?? null
  document.getElementById('limitText').textContent = state.limit ? idr(Number(state.limit)) : 'Belum ditetapkan'

  // ambil daftar pengajuan dari server
  let rows = [];
  try{
    const out = await gasFetch({action:'appsByNik', nik});
    if(out && out.ok) rows = out.rows || [];
  }catch(e){ rows = load('kbm_apps',[]).filter(a=>a.nik===nik); }

  rows.sort((a,b)=>a.ts-b.ts);
  if(rows.length){
    const last = rows[rows.length-1];
    const s = (last.status_admin || last.status_auto || 'menunggu').toLowerCase()
    state.status = s; state.approved = Number(last.approved||0)
  }else{ state.status='belum'; state.approved=0 }

  const chip = document.getElementById('statusChip')
  const badge = document.getElementById('statusBadge')
  const map = {'belum':['b-warn','Belum diajukan'],'menunggu':['b-info','Menunggu verifikasi'],'verifikasi':['b-info','Verifikasi Admin'],'disetujui':['b-ok','Disetujui'],'dicairkan':['b-ok','Dicairkan'],'ditolak':['b-warn','Ditolak'],'lunas':['b-ok','Lunas']}
  const [cls, text] = map[state.status] || ['b-warn','Belum diajukan']
  chip.className = 'chip'; chip.textContent=text;
  badge.className = 'badge '+cls; badge.textContent=text

  const blocked = hasActiveLoan(nik)
  document.getElementById('btnApply').disabled = blocked
  document.getElementById('blockNote').style.display = blocked ? 'block' : 'none'

  if(['disetujui','dicairkan','lunas'].includes(state.status) && state.approved>0){
    document.getElementById('approvedWrap').style.display='block'
    document.getElementById('approvedAmt').textContent = idr(state.approved)
  }else{
    document.getElementById('approvedWrap').style.display='none'
  }

  if(state.status==='dicairkan' || state.status==='lunas'){
    if(!state.installments.length && state.approved>0){
      const tenor=12, per=Math.round(state.approved/tenor)
      state.installments = [...Array(tenor)].map((_,i)=>({n:i+1, due:`${new Date().getFullYear()}-${String(i+1).padStart(2,'0')}-10`, amt:per, paid:i<1}))
    }
    renderInst(); document.getElementById('instWrap').style.display='block'
  }else{
    document.getElementById('instWrap').style.display='none'
    state.installments=[]
  }
  renderTicker();
}

async function applyNow(){
  const nik = localStorage.getItem('kbm_nik'); if(!nik) return alert('Belum login')
  if(hasActiveLoan(nik)) return alert('Masih ada pinjaman aktif (belum lunas)')
  try{
    const out = await gasFetch({action:'apply', nik, period:state.period});
    if(out && out.ok){ alert('Pengajuan terkirim. Menunggu verifikasi admin.'); refreshStatus(); }
    else alert(out?.msg||'Gagal mengirim pengajuan');
  }catch(e){
    // fallback demo (tetap agar UX lanjut)
    const apps=load('kbm_apps',[]); apps.push({ts:Date.now(), nik, period:state.period, status_auto:'menunggu', status_admin:'', approved:0}); save('kbm_apps',apps);
    alert('Pengajuan tersimpan (mode demo).'); refreshStatus();
  }
}
function refreshStatus(){ renderHome(); renderLoans(); }

/* ===== CICILAN ===== */
function renderInst(){
  const wrap=document.getElementById('instList'); wrap.innerHTML=''
  state.installments.forEach(it=>{
    const div=document.createElement('div')
    div.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #E6F1FC;border-radius:14px;padding:12px;background:#F7FBFF'
    div.innerHTML=`<div><div style="font-weight:900">Cicilan #${it.n}</div><div class="muted">Jatuh tempo ${it.due}</div></div>
                   <div style="text-align:right"><div style="font-weight:900">${idr(it.amt)}</div>
                   <span class="badge ${it.paid?'b-ok':'b-warn'}">${it.paid?'Lunas':'Belum'}</span></div>`
    wrap.appendChild(div)
  })
}

/* ===== LIST PINJAMAN ===== */
async function renderLoans(){
  const nik = localStorage.getItem('kbm_nik'); if(!nik) return
  const list=document.getElementById('loansList'); list.innerHTML=''

  let rows = [];
  try{
    const out = await gasFetch({action:'appsByNik', nik});
    if(out && out.ok) rows = out.rows || [];
  }catch(e){
    rows = load('kbm_apps',[]).filter(a=>a.nik===nik);
  }
  rows.sort((a,b)=>b.ts-a.ts);

  rows.forEach(a=>{
    const status=(a.status_admin||a.status_auto||'menunggu').toLowerCase()
    const tag = status==='ditolak'?'b-warn':(['disetujui','dicairkan','lunas'].includes(status)?'b-ok':'b-info')
    const t = new Date(a.ts).toLocaleString('id-ID',{dateStyle:'medium', timeStyle:'short'})
    const approved = a.approved? `<div class="muted">Disetujui: <b>${idr(a.approved)}</b></div>` : ''
    const item = document.createElement('div')
    item.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #E6F1FC;border-radius:14px;padding:12px;background:#F7FBFF'
    item.innerHTML = `<div><div style="font-weight:900">Pengajuan ${a.period||new Date(a.ts).getFullYear()}</div><div class="muted">${t}</div>${approved}</div><span class="badge ${tag}">${status}</span>`
    list.appendChild(item)
  })
}

/* ===== ACCOUNT ===== */
function currentUser(){ const nik = localStorage.getItem('kbm_nik'); if(!nik) return null; const users=load('kbm_users',[]); return users.find(u=>u.nik===nik)||null }
function renderAccount(){
  const u=currentUser(); if(!u) return
  document.getElementById('accName').textContent = u.nama || 'Karyawan'
  document.getElementById('accId').textContent = `NIK ${mask(u.nik)} â€¢ NIP ${mask(u.nip)}`
  document.getElementById('avatar').src = u.profile?.photo || 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><rect width=%22128%22 height=%22128%22 rx=%2264%22 fill=%2316A9FF/><circle cx=%2264%22 cy=%2248%22 r=%2228%22 fill=%23E6F7FF/><rect x=%2220%22 y=%2276%22 width=%2288%22 height=%2238%22 rx=%2219%22 fill=%23CFF0FF/></svg>'
  document.getElementById('p_nama').value   = u.nama || ''
  document.getElementById('p_jabatan').value= u.profile?.jabatan || ''
  document.getElementById('p_unit').value   = u.profile?.unit || ''
  document.getElementById('p_tempat').value = u.profile?.tempat || ''
  document.getElementById('p_tgl').value    = u.profile?.tgl || ''
  document.getElementById('p_alamat').value = u.profile?.alamat || ''
  document.getElementById('p_hp').value     = u.phone || ''
}
function saveProfile(){
  const u=currentUser(); if(!u) return
  u.nama = document.getElementById('p_nama').value.trim()
  u.phone= document.getElementById('p_hp').value.trim()
  u.profile = u.profile || {}
  u.profile.jabatan = document.getElementById('p_jabatan').value.trim()
  u.profile.unit    = document.getElementById('p_unit').value.trim()
  u.profile.tempat  = document.getElementById('p_tempat').value.trim()
  u.profile.tgl     = document.getElementById('p_tgl').value
  u.profile.alamat  = document.getElementById('p_alamat').value.trim()
  const users=load('kbm_users',[]); const i=users.findIndex(x=>x.nik===u.nik); if(i>-1){ users[i]=u; save('kbm_users',users) }
  localStorage.setItem('kbm_name', u.nama||'Karyawan')
  document.getElementById('accName').textContent = u.nama || 'Karyawan'
  const ok=document.getElementById('saveOk'); ok.style.display='block'; setTimeout(()=>ok.style.display='none',1500)
}
function onPhoto(e){
  const f=e.target.files[0]; if(!f) return
  const r=new FileReader(); r.onload=()=>{
    const img=new Image(); img.onload=()=>{
      const s=256, c=document.createElement('canvas'); c.width=s; c.height=s; const ctx=c.getContext('2d')
      const m=Math.min(img.width,img.height), sx=(img.width-m)/2, sy=(img.height-m)/2
      ctx.drawImage(img,sx,sy,m,m,0,0,s,s); const data=c.toDataURL('image/jpeg',.85)
      const u=currentUser(); if(!u) return; u.profile=u.profile||{}; u.profile.photo=data
      const users=load('kbm_users',[]); const i=users.findIndex(x=>x.nik===u.nik); if(i>-1){ users[i]=u; save('kbm_users',users) }
      document.getElementById('avatar').src=data
    }; img.src=r.result
  }; r.readAsDataURL(f); e.target.value=''
}
function removePhoto(){
  const u=currentUser(); if(!u) return
  if(u.profile) u.profile.photo=''
  const users=load('kbm_users',[]); const i=users.findIndex(x=>x.nik===u.nik); if(i>-1){ users[i]=u; save('kbm_users',users) }
  renderAccount()
}

/* ===== TICKER ===== */
function renderTicker(){
  const arr = load('kbm_news', [])
  const txt = arr.length ? ("&nbsp;&nbsp;â€¢&nbsp;&nbsp;" + arr.join("&nbsp;&nbsp;â€¢&nbsp;&nbsp;")) : "Tidak ada pengumuman";
  const el = document.getElementById('tickerText'); if(el) el.innerHTML = `<span>${txt}</span>`;
}
</script>
</body>
</html>
